<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste do Sistema de PersistÃªncia</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        border: 1px solid #ddd;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
      .timestamp {
        color: #666;
        font-size: 0.9em;
      }
      .status {
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 3px;
      }
      .status.ok {
        background: #d4edda;
        color: #155724;
      }
      .status.fail {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª Teste Completo do Sistema de PersistÃªncia</h1>

    <div class="test-section info">
      <h2>ğŸ“‹ Status do Sistema</h2>
      <div id="system-status">Carregando...</div>
    </div>

    <div class="test-section">
      <h2>ğŸ”§ Testes de Funcionalidade</h2>
      <button onclick="testLocalStorage()">1. Testar localStorage</button>
      <button onclick="testTimestampLogic()">
        2. Testar LÃ³gica de Timestamps
      </button>
      <button onclick="testConfigPriority()">
        3. Testar Prioridade de Config
      </button>
      <button onclick="testExportImport()">4. Testar Export/Import</button>
      <button onclick="clearAllData()">ğŸ—‘ï¸ Limpar Todos os Dados</button>
    </div>

    <div class="test-section">
      <h2>ğŸ“Š SimulaÃ§Ã£o de CenÃ¡rios</h2>
      <button onclick="simulateAdminEdit()">Simular EdiÃ§Ã£o Admin</button>
      <button onclick="simulateGlobalUpdate()">
        Simular AtualizaÃ§Ã£o Global
      </button>
      <button onclick="simulateNewUser()">Simular Novo UsuÃ¡rio</button>
    </div>

    <div class="test-section">
      <h2>ğŸ“ Log de Testes</h2>
      <div id="test-log" class="log"></div>
      <button onclick="clearLog()">Limpar Log</button>
    </div>

    <script>
      // UtilitÃ¡rios de log
      function log(message, type = "info") {
        const logDiv = document.getElementById("test-log");
        const timestamp = new Date().toLocaleTimeString();
        const typeColors = {
          success: "#28a745",
          error: "#dc3545",
          warning: "#ffc107",
          info: "#17a2b8",
        };

        logDiv.innerHTML += `
                <div style="color: ${typeColors[type] || "#333"}">
                    <span class="timestamp">[${timestamp}]</span> ${message}
                </div>
            `;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function clearLog() {
        document.getElementById("test-log").innerHTML = "";
      }

      // FunÃ§Ã£o para verificar status do sistema
      function checkSystemStatus() {
        const statusDiv = document.getElementById("system-status");

        // Verifica localStorage
        const hasLocalData = !!localStorage.getItem("panfleto_data");
        const hasBackup = !!localStorage.getItem("panfleto_data_backup");
        const hasSession = !!sessionStorage.getItem("panfleto_data_session");
        const localTimestamp = localStorage.getItem("panfleto_data_timestamp");

        // Verifica config remoto
        let hasRemoteConfig = false;
        fetch("./config.json")
          .then((response) => response.ok)
          .then((exists) => {
            hasRemoteConfig = exists;

            statusDiv.innerHTML = `
                        <div style="display: grid; gap: 10px;">
                            <div>ğŸ“‚ Dados locais: <span class="status ${
                              hasLocalData ? "ok" : "fail"
                            }">${hasLocalData ? "SIM" : "NÃƒO"}</span></div>
                            <div>ğŸ’¾ Backup local: <span class="status ${
                              hasBackup ? "ok" : "fail"
                            }">${hasBackup ? "SIM" : "NÃƒO"}</span></div>
                            <div>ğŸ”„ Session backup: <span class="status ${
                              hasSession ? "ok" : "fail"
                            }">${hasSession ? "SIM" : "NÃƒO"}</span></div>
                            <div>ğŸŒ Config remoto: <span class="status ${
                              hasRemoteConfig ? "ok" : "fail"
                            }">${hasRemoteConfig ? "SIM" : "NÃƒO"}</span></div>
                            <div>â° Ãšltima alteraÃ§Ã£o: ${
                              localTimestamp
                                ? new Date(localTimestamp).toLocaleString()
                                : "Nunca"
                            }</div>
                        </div>
                    `;
          })
          .catch(() => {
            statusDiv.innerHTML = `
                        <div style="display: grid; gap: 10px;">
                            <div>ğŸ“‚ Dados locais: <span class="status ${
                              hasLocalData ? "ok" : "fail"
                            }">${hasLocalData ? "SIM" : "NÃƒO"}</span></div>
                            <div>ğŸ’¾ Backup local: <span class="status ${
                              hasBackup ? "ok" : "fail"
                            }">${hasBackup ? "SIM" : "NÃƒO"}</span></div>
                            <div>ğŸ”„ Session backup: <span class="status ${
                              hasSession ? "ok" : "fail"
                            }">${hasSession ? "SIM" : "NÃƒO"}</span></div>
                            <div>ğŸŒ Config remoto: <span class="status fail">ERRO</span></div>
                            <div>â° Ãšltima alteraÃ§Ã£o: ${
                              localTimestamp
                                ? new Date(localTimestamp).toLocaleString()
                                : "Nunca"
                            }</div>
                        </div>
                    `;
          });
      }

      // Testes especÃ­ficos
      function testLocalStorage() {
        log("ğŸ§ª Iniciando teste de localStorage...", "info");

        try {
          // Teste de escrita
          const testData = {
            building: { name: "Teste Building " + Date.now() },
            test: true,
            timestamp: new Date().toISOString(),
          };

          localStorage.setItem("panfleto_data", JSON.stringify(testData));
          localStorage.setItem("panfleto_data_timestamp", testData.timestamp);
          localStorage.setItem(
            "panfleto_data_backup",
            JSON.stringify(testData)
          );
          sessionStorage.setItem(
            "panfleto_data_session",
            JSON.stringify(testData)
          );

          log("âœ… Dados salvos com sucesso em todos os storages", "success");

          // Teste de leitura
          const readData = localStorage.getItem("panfleto_data");
          const parsedData = JSON.parse(readData);

          if (parsedData.building.name === testData.building.name) {
            log("âœ… Dados lidos corretamente", "success");
          } else {
            log("âŒ Erro na leitura dos dados", "error");
          }

          checkSystemStatus();
        } catch (error) {
          log("âŒ Erro no teste de localStorage: " + error.message, "error");
        }
      }

      function testTimestampLogic() {
        log("ğŸ§ª Testando lÃ³gica de timestamps...", "info");

        try {
          // Simula config remoto antigo
          const remoteTimestamp = new Date("2025-01-28T17:10:00.000Z");

          // Simula config local mais recente
          const localTimestamp = new Date();

          log(
            `ğŸ“… Timestamp remoto: ${remoteTimestamp.toLocaleString()}`,
            "info"
          );
          log(`ğŸ“… Timestamp local: ${localTimestamp.toLocaleString()}`, "info");

          if (localTimestamp > remoteTimestamp) {
            log("âœ… LÃ³gica correta: Local mais recente que remoto", "success");
          } else {
            log("âŒ Problema na lÃ³gica de timestamp", "error");
          }

          // Testa cenÃ¡rio inverso
          const futureRemote = new Date(Date.now() + 86400000); // 1 dia no futuro
          if (futureRemote > localTimestamp) {
            log(
              "âœ… LÃ³gica correta: Remoto futuro prevalece sobre local",
              "success"
            );
          } else {
            log("âŒ Problema na comparaÃ§Ã£o de timestamps futuros", "error");
          }
        } catch (error) {
          log("âŒ Erro no teste de timestamps: " + error.message, "error");
        }
      }

      function testConfigPriority() {
        log("ğŸ§ª Testando prioridade de configuraÃ§Ãµes...", "info");

        // Simula cenÃ¡rio 1: SÃ³ config local
        localStorage.setItem(
          "panfleto_data",
          JSON.stringify({ scenario: "local-only" })
        );
        localStorage.setItem(
          "panfleto_data_timestamp",
          new Date().toISOString()
        );
        log("ğŸ“‚ CenÃ¡rio 1: Apenas config local - deve usar local", "info");

        // Simula cenÃ¡rio 2: Config local mais recente
        const recentTime = new Date().toISOString();
        localStorage.setItem("panfleto_data_timestamp", recentTime);
        log(
          "ğŸ“‚ CenÃ¡rio 2: Config local mais recente - deve usar local",
          "info"
        );

        // Simula cenÃ¡rio 3: Config remoto mais recente (seria testado com config.json real)
        log(
          "ğŸ“‚ CenÃ¡rio 3: Config remoto mais recente - deve usar remoto",
          "info"
        );

        log(
          "âœ… Teste de prioridade concluÃ­do - verificar console do app principal",
          "success"
        );
      }

      function testExportImport() {
        log("ğŸ§ª Testando funcionalidade de export/import...", "info");

        try {
          // Simula dados para export
          const testData = {
            version: "1.0",
            lastUpdated: new Date().toISOString(),
            building: {
              name: "EdifÃ­cio Teste Export",
              address: "Rua Teste, 123",
            },
            contacts: {
              portaria: {
                phone: "(00) 0000-0000",
              },
            },
          };

          // Simula export
          const dataString = JSON.stringify(testData, null, 2);
          log("âœ… Export simulado com sucesso", "success");
          log(`ğŸ“Š Tamanho do arquivo: ${dataString.length} caracteres`, "info");

          // Simula import
          try {
            const importedData = JSON.parse(dataString);
            if (importedData.version && importedData.building) {
              log(
                "âœ… Import simulado com sucesso - estrutura vÃ¡lida",
                "success"
              );
            } else {
              log("âŒ Estrutura de import invÃ¡lida", "error");
            }
          } catch (parseError) {
            log("âŒ Erro no parse do JSON: " + parseError.message, "error");
          }
        } catch (error) {
          log("âŒ Erro no teste de export/import: " + error.message, "error");
        }
      }

      function simulateAdminEdit() {
        log("ğŸ‘¤ Simulando ediÃ§Ã£o do admin...", "info");

        const adminData = {
          building: {
            name: "EdifÃ­cio Editado pelo Admin",
            address: "EndereÃ§o atualizado via admin",
            welcomeMessage:
              "Mensagem editada em " + new Date().toLocaleString(),
          },
          contacts: {
            portaria: {
              phone: "(21) 9999-8888",
            },
          },
          lastUpdated: new Date().toISOString(),
        };

        // Salva como admin
        localStorage.setItem("panfleto_data", JSON.stringify(adminData));
        localStorage.setItem("panfleto_data_backup", JSON.stringify(adminData));
        localStorage.setItem("panfleto_data_timestamp", adminData.lastUpdated);
        sessionStorage.setItem(
          "panfleto_data_session",
          JSON.stringify(adminData)
        );

        log("âœ… AlteraÃ§Ãµes do admin salvas localmente", "success");
        log("ğŸ’¡ Recarregue a pÃ¡gina principal para ver as alteraÃ§Ãµes", "info");

        checkSystemStatus();
      }

      function simulateGlobalUpdate() {
        log("ğŸŒ Simulando atualizaÃ§Ã£o global...", "info");
        log("ğŸ“ Para simular, vocÃª precisaria:", "info");
        log('1. Usar "Publicar MudanÃ§as" no admin', "info");
        log("2. Substituir public/config.json", "info");
        log("3. Fazer deploy da aplicaÃ§Ã£o", "info");
        log("ğŸ’¡ Isso faria todos os usuÃ¡rios verem as mudanÃ§as", "warning");
      }

      function simulateNewUser() {
        log("ğŸ‘¥ Simulando acesso de novo usuÃ¡rio...", "info");

        // Limpa dados locais (simula usuÃ¡rio em outro computador)
        const backup = {
          data: localStorage.getItem("panfleto_data"),
          backup: localStorage.getItem("panfleto_data_backup"),
          timestamp: localStorage.getItem("panfleto_data_timestamp"),
          session: sessionStorage.getItem("panfleto_data_session"),
        };

        localStorage.removeItem("panfleto_data");
        localStorage.removeItem("panfleto_data_backup");
        localStorage.removeItem("panfleto_data_timestamp");
        sessionStorage.removeItem("panfleto_data_session");

        log("ğŸ§¹ Dados locais limpos (simulando novo usuÃ¡rio)", "info");
        log("ğŸ’¡ Novo usuÃ¡rio verÃ¡ apenas config.json remoto", "info");

        // Restaura dados apÃ³s 3 segundos
        setTimeout(() => {
          if (backup.data) localStorage.setItem("panfleto_data", backup.data);
          if (backup.backup)
            localStorage.setItem("panfleto_data_backup", backup.backup);
          if (backup.timestamp)
            localStorage.setItem("panfleto_data_timestamp", backup.timestamp);
          if (backup.session)
            sessionStorage.setItem("panfleto_data_session", backup.session);

          log("ğŸ”„ Dados restaurados automaticamente", "success");
          checkSystemStatus();
        }, 3000);

        checkSystemStatus();
      }

      function clearAllData() {
        if (confirm("Tem certeza que deseja limpar TODOS os dados?")) {
          localStorage.removeItem("panfleto_data");
          localStorage.removeItem("panfleto_data_backup");
          localStorage.removeItem("panfleto_data_timestamp");
          sessionStorage.removeItem("panfleto_data_session");

          log("ğŸ—‘ï¸ Todos os dados foram removidos", "warning");
          checkSystemStatus();
        }
      }

      // InicializaÃ§Ã£o
      document.addEventListener("DOMContentLoaded", function () {
        checkSystemStatus();
        log("ğŸš€ Sistema de testes inicializado", "success");
      });
    </script>
  </body>
</html>
