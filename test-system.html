<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste do Sistema de Persist√™ncia</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        border: 1px solid #ddd;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
      .timestamp {
        color: #666;
        font-size: 0.9em;
      }
      .status {
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 3px;
      }
      .status.ok {
        background: #d4edda;
        color: #155724;
      }
      .status.fail {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Teste Completo do Sistema de Persist√™ncia</h1>

    <div class="test-section info">
      <h2>üìã Status do Sistema</h2>
      <div id="system-status">Carregando...</div>
    </div>

    <div class="test-section">
      <h2>üîß Testes de Funcionalidade</h2>
      <button onclick="testLocalStorage()">1. Testar localStorage</button>
      <button onclick="testTimestampLogic()">
        2. Testar L√≥gica de Timestamps
      </button>
      <button onclick="testConfigPriority()">
        3. Testar Prioridade de Config
      </button>
      <button onclick="testExportImport()">4. Testar Export/Import</button>
      <button onclick="clearAllData()">üóëÔ∏è Limpar Todos os Dados</button>
    </div>

    <div class="test-section">
      <h2>üìä Simula√ß√£o de Cen√°rios</h2>
      <button onclick="simulateAdminEdit()">Simular Edi√ß√£o Admin</button>
      <button onclick="simulateGlobalUpdate()">
        Simular Atualiza√ß√£o Global
      </button>
      <button onclick="simulateNewUser()">Simular Novo Usu√°rio</button>
    </div>

    <div class="test-section">
      <h2>üìù Log de Testes</h2>
      <div id="test-log" class="log"></div>
      <button onclick="clearLog()">Limpar Log</button>
    </div>

    <script>
      // Utilit√°rios de log
      function log(message, type = "info") {
        const logDiv = document.getElementById("test-log");
        const timestamp = new Date().toLocaleTimeString();
        const typeColors = {
          success: "#28a745",
          error: "#dc3545",
          warning: "#ffc107",
          info: "#17a2b8",
        };

        logDiv.innerHTML += `
                <div style="color: ${typeColors[type] || "#333"}">
                    <span class="timestamp">[${timestamp}]</span> ${message}
                </div>
            `;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function clearLog() {
        document.getElementById("test-log").innerHTML = "";
      }

      // Fun√ß√£o para verificar status do sistema
      function checkSystemStatus() {
        const statusDiv = document.getElementById("system-status");

        // Verifica localStorage
        const hasLocalData = !!localStorage.getItem("panfleto_data");
        const hasBackup = !!localStorage.getItem("panfleto_data_backup");
        const hasSession = !!sessionStorage.getItem("panfleto_data_session");
        const localTimestamp = localStorage.getItem("panfleto_data_timestamp");

        // Verifica config remoto
        let hasRemoteConfig = false;
        fetch("./config.json")
          .then((response) => response.ok)
          .then((exists) => {
            hasRemoteConfig = exists;

            statusDiv.innerHTML = `
                        <div style="display: grid; gap: 10px;">
                            <div>üìÇ Dados locais: <span class="status ${
                              hasLocalData ? "ok" : "fail"
                            }">${hasLocalData ? "SIM" : "N√ÉO"}</span></div>
                            <div>üíæ Backup local: <span class="status ${
                              hasBackup ? "ok" : "fail"
                            }">${hasBackup ? "SIM" : "N√ÉO"}</span></div>
                            <div>üîÑ Session backup: <span class="status ${
                              hasSession ? "ok" : "fail"
                            }">${hasSession ? "SIM" : "N√ÉO"}</span></div>
                            <div>üåê Config remoto: <span class="status ${
                              hasRemoteConfig ? "ok" : "fail"
                            }">${hasRemoteConfig ? "SIM" : "N√ÉO"}</span></div>
                            <div>‚è∞ √öltima altera√ß√£o: ${
                              localTimestamp
                                ? new Date(localTimestamp).toLocaleString()
                                : "Nunca"
                            }</div>
                        </div>
                    `;
          })
          .catch(() => {
            statusDiv.innerHTML = `
                        <div style="display: grid; gap: 10px;">
                            <div>üìÇ Dados locais: <span class="status ${
                              hasLocalData ? "ok" : "fail"
                            }">${hasLocalData ? "SIM" : "N√ÉO"}</span></div>
                            <div>üíæ Backup local: <span class="status ${
                              hasBackup ? "ok" : "fail"
                            }">${hasBackup ? "SIM" : "N√ÉO"}</span></div>
                            <div>üîÑ Session backup: <span class="status ${
                              hasSession ? "ok" : "fail"
                            }">${hasSession ? "SIM" : "N√ÉO"}</span></div>
                            <div>üåê Config remoto: <span class="status fail">ERRO</span></div>
                            <div>‚è∞ √öltima altera√ß√£o: ${
                              localTimestamp
                                ? new Date(localTimestamp).toLocaleString()
                                : "Nunca"
                            }</div>
                        </div>
                    `;
          });
      }

      // Testes espec√≠ficos
      function testLocalStorage() {
        log("üß™ Iniciando teste de localStorage...", "info");

        try {
          // Teste de escrita
          const testData = {
            building: { name: "Teste Building " + Date.now() },
            test: true,
            timestamp: new Date().toISOString(),
          };

          localStorage.setItem("panfleto_data", JSON.stringify(testData));
          localStorage.setItem("panfleto_data_timestamp", testData.timestamp);
          localStorage.setItem(
            "panfleto_data_backup",
            JSON.stringify(testData)
          );
          sessionStorage.setItem(
            "panfleto_data_session",
            JSON.stringify(testData)
          );

          log("‚úÖ Dados salvos com sucesso em todos os storages", "success");

          // Teste de leitura
          const readData = localStorage.getItem("panfleto_data");
          const parsedData = JSON.parse(readData);

          if (parsedData.building.name === testData.building.name) {
            log("‚úÖ Dados lidos corretamente", "success");
          } else {
            log("‚ùå Erro na leitura dos dados", "error");
          }

          checkSystemStatus();
        } catch (error) {
          log("‚ùå Erro no teste de localStorage: " + error.message, "error");
        }
      }

      function testTimestampLogic() {
        log("üß™ Testando l√≥gica de timestamps...", "info");

        try {
          // Simula config remoto antigo
          const remoteTimestamp = new Date("2025-01-28T17:10:00.000Z");

          // Simula config local mais recente
          const localTimestamp = new Date();

          log(
            `üìÖ Timestamp remoto: ${remoteTimestamp.toLocaleString()}`,
            "info"
          );
          log(`üìÖ Timestamp local: ${localTimestamp.toLocaleString()}`, "info");

          if (localTimestamp > remoteTimestamp) {
            log("‚úÖ L√≥gica correta: Local mais recente que remoto", "success");
          } else {
            log("‚ùå Problema na l√≥gica de timestamp", "error");
          }

          // Testa cen√°rio inverso
          const futureRemote = new Date(Date.now() + 86400000); // 1 dia no futuro
          if (futureRemote > localTimestamp) {
            log(
              "‚úÖ L√≥gica correta: Remoto futuro prevalece sobre local",
              "success"
            );
          } else {
            log("‚ùå Problema na compara√ß√£o de timestamps futuros", "error");
          }
        } catch (error) {
          log("‚ùå Erro no teste de timestamps: " + error.message, "error");
        }
      }

      function testConfigPriority() {
        log("üß™ Testando prioridade de configura√ß√µes...", "info");

        // Simula cen√°rio 1: S√≥ config local
        localStorage.setItem(
          "panfleto_data",
          JSON.stringify({ scenario: "local-only" })
        );
        localStorage.setItem(
          "panfleto_data_timestamp",
          new Date().toISOString()
        );
        log("üìÇ Cen√°rio 1: Apenas config local - deve usar local", "info");

        // Simula cen√°rio 2: Config local mais recente
        const recentTime = new Date().toISOString();
        localStorage.setItem("panfleto_data_timestamp", recentTime);
        log(
          "üìÇ Cen√°rio 2: Config local mais recente - deve usar local",
          "info"
        );

        // Simula cen√°rio 3: Config remoto mais recente (seria testado com config.json real)
        log(
          "üìÇ Cen√°rio 3: Config remoto mais recente - deve usar remoto",
          "info"
        );

        log(
          "‚úÖ Teste de prioridade conclu√≠do - verificar console do app principal",
          "success"
        );
      }

      function testExportImport() {
        log("üß™ Testando funcionalidade de export/import...", "info");

        try {
          // Simula dados para export
          const testData = {
            version: "1.0",
            lastUpdated: new Date().toISOString(),
            building: {
              name: "Edif√≠cio Teste Export",
              address: "Rua Teste, 123",
            },
            contacts: {
              portaria: {
                phone: "(00) 0000-0000",
              },
            },
          };

          // Simula export
          const dataString = JSON.stringify(testData, null, 2);
          log("‚úÖ Export simulado com sucesso", "success");
          log(`üìä Tamanho do arquivo: ${dataString.length} caracteres`, "info");

          // Simula import
          try {
            const importedData = JSON.parse(dataString);
            if (importedData.version && importedData.building) {
              log(
                "‚úÖ Import simulado com sucesso - estrutura v√°lida",
                "success"
              );
            } else {
              log("‚ùå Estrutura de import inv√°lida", "error");
            }
          } catch (parseError) {
            log("‚ùå Erro no parse do JSON: " + parseError.message, "error");
          }
        } catch (error) {
          log("‚ùå Erro no teste de export/import: " + error.message, "error");
        }
      }

      function simulateAdminEdit() {
        log("üë§ Simulando edi√ß√£o do admin...", "info");

        const adminData = {
          building: {
            name: "Edif√≠cio Editado pelo Admin",
            address: "Endere√ßo atualizado via admin",
            welcomeMessage:
              "Mensagem editada em " + new Date().toLocaleString(),
          },
          contacts: {
            portaria: {
              phone: "(21) 9999-8888",
            },
          },
          lastUpdated: new Date().toISOString(),
        };

        // Salva como admin
        localStorage.setItem("panfleto_data", JSON.stringify(adminData));
        localStorage.setItem("panfleto_data_backup", JSON.stringify(adminData));
        localStorage.setItem("panfleto_data_timestamp", adminData.lastUpdated);
        sessionStorage.setItem(
          "panfleto_data_session",
          JSON.stringify(adminData)
        );

        log("‚úÖ Altera√ß√µes do admin salvas localmente", "success");
        log("üí° Recarregue a p√°gina principal para ver as altera√ß√µes", "info");

        checkSystemStatus();
      }

      function simulateGlobalUpdate() {
        log("üåç Simulando atualiza√ß√£o global...", "info");
        log("üìù Para simular, voc√™ precisaria:", "info");
        log('1. Usar "Publicar Mudan√ßas" no admin', "info");
        log("2. Substituir public/config.json", "info");
        log("3. Fazer deploy da aplica√ß√£o", "info");
        log("üí° Isso faria todos os usu√°rios verem as mudan√ßas", "warning");
      }

      function simulateNewUser() {
        log("üë• Simulando acesso de novo usu√°rio...", "info");

        // Limpa dados locais (simula usu√°rio em outro computador)
        const backup = {
          data: localStorage.getItem("panfleto_data"),
          backup: localStorage.getItem("panfleto_data_backup"),
          timestamp: localStorage.getItem("panfleto_data_timestamp"),
          session: sessionStorage.getItem("panfleto_data_session"),
        };

        localStorage.removeItem("panfleto_data");
        localStorage.removeItem("panfleto_data_backup");
        localStorage.removeItem("panfleto_data_timestamp");
        sessionStorage.removeItem("panfleto_data_session");

        log("üßπ Dados locais limpos (simulando novo usu√°rio)", "info");
        log("üí° Novo usu√°rio ver√° apenas config.json remoto", "info");

        // Restaura dados ap√≥s 3 segundos
        setTimeout(() => {
          if (backup.data) localStorage.setItem("panfleto_data", backup.data);
          if (backup.backup)
            localStorage.setItem("panfleto_data_backup", backup.backup);
          if (backup.timestamp)
            localStorage.setItem("panfleto_data_timestamp", backup.timestamp);
          if (backup.session)
            sessionStorage.setItem("panfleto_data_session", backup.session);

          log("üîÑ Dados restaurados automaticamente", "success");
          checkSystemStatus();
        }, 3000);

        checkSystemStatus();
      }

      function clearAllData() {
        if (confirm("Tem certeza que deseja limpar TODOS os dados?")) {
          localStorage.removeItem("panfleto_data");
          localStorage.removeItem("panfleto_data_backup");
          localStorage.removeItem("panfleto_data_timestamp");
          sessionStorage.removeItem("panfleto_data_session");

          log("üóëÔ∏è Todos os dados foram removidos", "warning");
          checkSystemStatus();
        }
      }

      // Inicializa√ß√£o
      document.addEventListener("DOMContentLoaded", function () {
        checkSystemStatus();
        log("üöÄ Sistema de testes inicializado", "success");
      });
    </script>
  </body>
</html>
